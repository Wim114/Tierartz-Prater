<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tierambulanz Prater - Admin Panel</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #00ace2;
            --secondary-color: #005d83;
            --accent-color: #ebf9ff;
            --text-dark: #22242C;
            --success: #28a745;
            --danger: #ff4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }

        /* Admin Panel Styles */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .admin-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .announcement-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .edit-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        /* Form Styles */
        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 10px 15px;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0,172,226,0.25);
        }

        /* Tabs */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tabs .nav-link {
            color: var(--text-dark);
            border: none;
            padding: 12px 25px;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background: white;
            border-bottom: 3px solid var(--primary-color);
        }

        /* Quick Actions */
        .quick-action {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quick-action i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* Loading spinner */
        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.2em;
        }

        /* Website Preview */
        .website-preview {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 30px;
        }

        .preview-header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        .preview-content {
            padding: 20px;
            background: white;
            min-height: 200px;
        }

        .announcement-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            margin-bottom: 10px;
        }

        .hours-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-rule {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .rule-type {
            background: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        /* Hours table for preview */
        .hours-table {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .hours-table li {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
        }

        .hours-table li:last-child {
            border-bottom: none;
        }

        .hours-table .day {
            font-weight: 600;
            color: var(--text-dark);
        }

        .hours-table .time {
            color: var(--primary-color);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Admin Panel -->
    <div class="admin-container">
      <div class="admin-header">
          <div class="row align-items-center">
              <div class="col-md-6">
                  <h1><i class="fas fa-cog"></i> Tierambulanz Prater - Admin Panel</h1>
                  <p class="mb-0 text-muted">Verwalten Sie Ihre Website-Inhalte</p>
              </div>
              <div class="col-md-6 text-end">
                  <span class="text-muted me-3">
                      <i class="fas fa-user-shield"></i> Admin
                  </span>
                  <button class="edit-btn" onclick="viewWebsite()" aria-label="Website in neuem Tab √∂ffnen">
                      <i class="fas fa-eye"></i> Website Ansehen
                  </button>
                  <button class="btn btn-outline-secondary" onclick="logout()" aria-label="Vom Admin-Panel abmelden">
                      <i class="fas fa-sign-out-alt"></i> Abmelden
                  </button>
              </div>
          </div>
      </div>

      <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item" role="presentation">
              <a class="nav-link" data-bs-toggle="tab" href="#announcements" role="tab" aria-controls="announcements" aria-selected="false">
                  <i class="fas fa-bullhorn"></i> Ank√ºndigungen
              </a>
          </li>
          <li class="nav-item" role="presentation">
              <a class="nav-link active" data-bs-toggle="tab" href="#opening-hours" role="tab" aria-controls="opening-hours" aria-selected="true">
                  <i class="fas fa-clock"></i> √ñffnungszeiten
              </a>
          </li>
          <li class="nav-item" role="presentation">
              <a class="nav-link" data-bs-toggle="tab" href="#search-management" role="tab" aria-controls="search-management" aria-selected="false">
                  <i class="fas fa-search"></i> Suchverwaltung
              </a>
          </li>
      </ul>

        <div class="tab-content">
            <!-- Announcements Tab -->
            <div class="tab-pane fade" id="announcements" role="tabpanel" aria-labelledby="announcements-tab">
                <div class="admin-card">
                    <h3><i class="fas fa-plus-circle"></i> Neue Ank√ºndigung erstellen</h3>
                    <form id="announcementForm">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label" for="announcementType">Art der Ank√ºndigung</label>
                                <select class="form-select" id="announcementType" required aria-required="true">
                                    <option value="holiday">üññÔ∏è Urlaubszeit</option>
                                    <option value="emergency">üö® Notfall-Information</option>
                                    <option value="news">üì∞ Neuigkeiten</option>
                                    <option value="special">‚≠ê Sonderaktion</option>
                                    <option value="warning">‚ö†Ô∏è Wichtiger Hinweis</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="startDate">Start Datum</label>
                                <input type="datetime-local" class="form-control" id="startDate" required aria-required="true">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="endDate">End Datum</label>
                                <input type="datetime-local" class="form-control" id="endDate" required aria-required="true">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label" for="announcementTitle">Titel</label>
                                <input type="text" class="form-control" id="announcementTitle"
                                       placeholder="z.B. Urlaubszeit vom 24.12. bis 02.01." required aria-required="true">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label" for="announcementMessage">Nachricht</label>
                                <textarea class="form-control" id="announcementMessage" rows="3"
                                          placeholder="z.B. Wir sind vom 24. Dezember bis 2. Januar im Urlaub. In dringenden Notf√§llen wenden Sie sich bitte an die Tierklinik Wien unter +43 1 234567" required aria-required="true"></textarea>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label" for="substituteInfo">Vertretung (optional)</label>
                                <input type="text" class="form-control" id="substituteInfo"
                                       placeholder="z.B. Dr. M√ºller, Tierklinik Wien, Tel: +43 1 234567">
                            </div>
                            <div class="col-md-12">
                                <button type="submit" class="edit-btn" id="submitBtn">
                                    <i class="fas fa-save"></i> Ank√ºndigung Speichern
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Current Announcements -->
                <div class="admin-card">
                    <h3><i class="fas fa-list"></i> Aktuelle Ank√ºndigungen</h3>
                    <div id="announcementsList" role="region" aria-label="Liste der aktuellen Ank√ºndigungen" aria-live="polite">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">L√§dt...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UPDATED: Opening Hours Tab -->
            <div class="tab-pane fade show active" id="opening-hours" role="tabpanel" aria-labelledby="opening-hours-tab">
                <div class="admin-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="fas fa-clock"></i> Regul√§re √ñffnungszeiten</h3>
                        <button class="btn btn-outline-secondary" onclick="resetToDefaultHours()" aria-label="√ñffnungszeiten auf Standardwerte zur√ºcksetzen">
                            <i class="fas fa-undo"></i> Auf Standard zur√ºcksetzen
                        </button>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> √Ñndern Sie die √ñffnungszeiten, die auf Ihrer Website angezeigt werden. Die √Ñnderungen werden sofort √ºbernommen.
                    </div>

                    <div class="hours-row">
                        <strong style="width: 150px;">Montag - Freitag</strong>
                        <div class="time-input-group">
                            <label for="weekday-open-1" class="visually-hidden">Montag bis Freitag √ñffnung morgens</label>
                            <input type="time" class="form-control" id="weekday-open-1" value="09:00" style="width: 120px;" aria-label="√ñffnungszeit Vormittag">
                            <span aria-hidden="true">bis</span>
                            <label for="weekday-close-1" class="visually-hidden">Montag bis Freitag Schlie√üung morgens</label>
                            <input type="time" class="form-control" id="weekday-close-1" value="12:00" style="width: 120px;" aria-label="Schlie√üzeit Vormittag">
                            <span aria-hidden="true">&</span>
                            <label for="weekday-open-2" class="visually-hidden">Montag bis Freitag √ñffnung nachmittags</label>
                            <input type="time" class="form-control" id="weekday-open-2" value="16:00" style="width: 120px;" aria-label="√ñffnungszeit Nachmittag">
                            <span aria-hidden="true">bis</span>
                            <label for="weekday-close-2" class="visually-hidden">Montag bis Freitag Schlie√üung nachmittags</label>
                            <input type="time" class="form-control" id="weekday-close-2" value="19:00" style="width: 120px;" aria-label="Schlie√üzeit Nachmittag">
                        </div>
                    </div>

                    <div class="hours-row">
                        <strong style="width: 150px;">Samstag</strong>
                        <div class="time-input-group">
                            <label for="saturday-open" class="visually-hidden">Samstag √ñffnungszeit</label>
                            <input type="time" class="form-control" id="saturday-open" value="09:00" style="width: 120px;" aria-label="Samstag √ñffnungszeit">
                            <span aria-hidden="true">bis</span>
                            <label for="saturday-close" class="visually-hidden">Samstag Schlie√üzeit</label>
                            <input type="time" class="form-control" id="saturday-close" value="12:00" style="width: 120px;" aria-label="Samstag Schlie√üzeit">
                            <div class="form-check ms-3">
                                <input class="form-check-input" type="checkbox" id="saturday-closed" aria-describedby="saturday-closed-help">
                                <label class="form-check-label" for="saturday-closed">
                                    Geschlossen
                                </label>
                                <span id="saturday-closed-help" class="visually-hidden">Markieren Sie dies, wenn samstags geschlossen ist</span>
                            </div>
                        </div>
                    </div>

                    <div class="hours-row">
                        <strong style="width: 150px;">Sonntag</strong>
                        <div class="time-input-group">
                            <label for="sunday-open" class="visually-hidden">Sonntag √ñffnungszeit</label>
                            <input type="time" class="form-control" id="sunday-open" value="09:00" disabled style="width: 120px;" aria-label="Sonntag √ñffnungszeit">
                            <span aria-hidden="true">bis</span>
                            <label for="sunday-close" class="visually-hidden">Sonntag Schlie√üzeit</label>
                            <input type="time" class="form-control" id="sunday-close" value="12:00" disabled style="width: 120px;" aria-label="Sonntag Schlie√üzeit">
                            <div class="form-check ms-3">
                                <input class="form-check-input" type="checkbox" id="sunday-closed" checked aria-describedby="sunday-closed-help">
                                <label class="form-check-label" for="sunday-closed">
                                    Geschlossen
                                </label>
                                <span id="sunday-closed-help" class="visually-hidden">Markieren Sie dies, wenn sonntags geschlossen ist</span>
                            </div>
                        </div>
                    </div>

                    <button class="edit-btn mt-3" onclick="saveRegularHours()" aria-label="Ge√§nderte √ñffnungszeiten speichern">
                        <i class="fas fa-save"></i> √ñffnungszeiten Speichern
                    </button>

                    <button class="btn btn-outline-primary mt-3 ms-2" onclick="previewHoursOnMainSite()" aria-label="Hauptwebsite in neuem Tab √∂ffnen um √Ñnderungen zu √ºberpr√ºfen">
                        <i class="fas fa-eye"></i> Vorschau auf Hauptseite
                    </button>
                </div>

                <!-- Preview Section -->
                <div class="admin-card">
                    <h4><i class="fas fa-desktop"></i> Vorschau - So erscheint es auf der Website</h4>
                    <div class="website-preview">
                        <div class="preview-header">
                            <i class="fas fa-clock"></i> √ñffnungszeiten
                        </div>
                        <div class="preview-content">
                            <ul class="hours-table" id="previewHoursList" role="list" aria-label="Vorschau der √ñffnungszeiten">
                                <li role="listitem">
                                    <span class="day">Montag - Freitag</span>
                                    <span class="time">09:00-12:00 & 16:00-19:00</span>
                                </li>
                                <li role="listitem">
                                    <span class="day">Samstag</span>
                                    <span class="time">09:00 - 12:00</span>
                                </li>
                                <li role="listitem">
                                    <span class="day">Sonntag</span>
                                    <span class="time" style="color: #ff4444; font-weight: 700;">GESCHLOSSEN</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Management Tab -->
            <div class="tab-pane fade" id="search-management" role="tabpanel" aria-labelledby="search-management-tab">
                <div class="admin-card">
                    <h3><i class="fas fa-search"></i> Suchverwaltung & SEO</h3>

                    <ul class="nav nav-pills mb-3" style="background: #f8f9fa; padding: 10px; border-radius: 10px;" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" data-bs-toggle="pill" href="#pinned" role="tab" aria-controls="pinned" aria-selected="true">
                                <i class="fas fa-thumbtack"></i> Gepinnt
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="pill" href="#excluded" role="tab" aria-controls="excluded" aria-selected="false">
                                <i class="fas fa-ban"></i> Ausgeschlossen
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="pill" href="#synonyms" role="tab" aria-controls="synonyms" aria-selected="false">
                                <i class="fas fa-exchange-alt"></i> Synonyme
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="pill" href="#metadata" role="tab" aria-controls="metadata" aria-selected="false">
                                <i class="fas fa-tags"></i> Metadaten
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- Pinned Results -->
                        <div class="tab-pane fade show active" id="pinned" role="tabpanel">
                            <p class="text-muted">Pinnen Sie wichtige Seiten f√ºr Suchbegriffe</p>
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="pinnedKeyword" class="visually-hidden">Suchbegriff</label>
                                    <input type="text" class="form-control" id="pinnedKeyword" placeholder="Suchbegriff" aria-label="Suchbegriff f√ºr gepinnte Seite">
                                </div>
                                <div class="col-md-5">
                                    <label for="pinnedUrl" class="visually-hidden">URL</label>
                                    <input type="text" class="form-control" id="pinnedUrl" placeholder="URL" aria-label="URL der zu pinnenden Seite">
                                </div>
                                <div class="col-md-2">
                                    <button class="edit-btn" onclick="addPinnedResult()" aria-label="Gepinntes Suchergebnis hinzuf√ºgen">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="pinnedList" role="region" aria-label="Liste der gepinnten Suchergebnisse" aria-live="polite"></div>
                        </div>
                        <div class="tab-pane fade" id="excluded" role="tabpanel">
                            <p class="text-muted">Schlie√üen Sie Begriffe aus</p>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="excludedTerm" class="visually-hidden">Begriff zum Ausschlie√üen</label>
                                    <input type="text" class="form-control" id="excludedTerm" placeholder="Begriff" aria-label="Begriff der ausgeschlossen werden soll">
                                </div>
                                <div class="col-md-4">
                                    <button class="edit-btn" onclick="addExcludedTerm()" aria-label="Begriff von Suche ausschlie√üen">
                                        <i class="fas fa-ban"></i> Ausschlie√üen
                                    </button>
                                </div>
                            </div>
                            <div id="excludedList" role="region" aria-label="Liste der ausgeschlossenen Begriffe" aria-live="polite"></div>
                        </div>
                        <div class="tab-pane fade" id="synonyms" role="tabpanel">
                            <p class="text-muted">Definieren Sie Synonyme</p>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="synonymTerm" class="visually-hidden">Begriff</label>
                                    <input type="text" class="form-control" id="synonymTerm" placeholder="Begriff" aria-label="Hauptbegriff">
                                </div>
                                <div class="col-md-6">
                                    <label for="synonymAlias" class="visually-hidden">Synonyme</label>
                                    <input type="text" class="form-control" id="synonymAlias" placeholder="Synonyme (kommagetrennt)" aria-label="Synonyme durch Komma getrennt">
                                </div>
                                <div class="col-md-2">
                                    <button class="edit-btn" onclick="addSynonym()" aria-label="Synonym hinzuf√ºgen">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="synonymsList" role="region" aria-label="Liste der definierten Synonyme" aria-live="polite"></div>
                        </div>
                        <div class="tab-pane fade" id="metadata" role="tabpanel">
                            <p class="text-muted">SEO-Metadaten verwalten</p>
                            <div class="mb-3">
                                <label class="form-label" for="metaTitle">Seitentitel</label>
                                <input type="text" class="form-control" id="metaTitle"
                                       value="Tierambulanz Prater - Veterinary Practice Vienna" aria-describedby="metaTitle-help">
                                <small id="metaTitle-help" class="form-text text-muted">Der Titel erscheint in Suchergebnissen</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="metaDescription">Beschreibung</label>
                                <textarea class="form-control" id="metaDescription" rows="3" aria-describedby="metaDescription-help">Modern veterinary practice in Vienna.</textarea>
                                <small id="metaDescription-help" class="form-text text-muted">Die Beschreibung erscheint unter dem Titel in Suchergebnissen</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="metaKeywords">Keywords</label>
                                <input type="text" class="form-control" id="metaKeywords"
                                       value="Tierarzt Wien, veterinarian Vienna" aria-describedby="metaKeywords-help">
                                <small id="metaKeywords-help" class="form-text text-muted">Durch Komma getrennte Suchbegriffe</small>
                            </div>
                            <button class="edit-btn" onclick="saveMetadata()" aria-label="SEO-Metadaten speichern">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Check authentication
        if (sessionStorage.getItem('adminAuth') !== 'true') {
            window.location.href = '/admin/';
        }

        // API Configuration
        const API_BASE = '/.netlify/functions';
        const IS_PRODUCTION = window.location.hostname.includes('netlify') ||
                             window.location.hostname.includes('tierambulanz');

        // Default hours configuration
        const DEFAULT_HOURS = {
            weekday: {
                morning: { open: '09:00', close: '12:00' },
                afternoon: { open: '16:00', close: '19:00' }
            },
            saturday: {
                open: '09:00',
                close: '12:00',
                closed: false
            },
            sunday: {
                closed: true,
                open: '',
                close: ''
            }
        };

        // ============================================
        // ANNOUNCEMENTS MANAGEMENT (UNCHANGED)
        // ============================================

        async function loadAnnouncements() {
            try {
                if (IS_PRODUCTION) {
                    const response = await fetch(`${API_BASE}/get-announcements`);
                    if (response.ok) {
                        const announcements = await response.json();
                        displayAnnouncements(announcements);
                    } else {
                        throw new Error(`Failed to load announcements (Status: ${response.status})`);
                    }
                } else {
                    const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
                    displayAnnouncements(announcements);
                }
            } catch (error) {
                console.error('Failed to load announcements:', error);
                document.getElementById('announcementsList').innerHTML =
                    `<div class="alert alert-danger"><strong>Fehler beim Laden der Ank√ºndigungen:</strong><br>${error.message}</div>`;
            }
        }

        async function createAnnouncement(data) {
            try {
                if (IS_PRODUCTION) {
                    const response = await fetch(`${API_BASE}/create-announcement`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Auth': sessionStorage.getItem('adminAuth')
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showNotification('Ank√ºndigung erstellt!', 'success');
                        loadAnnouncements();
                    } else {
                        throw new Error('Failed to create announcement');
                    }
                } else {
                    const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
                    const newAnnouncement = {
                        ...data,
                        id: Date.now().toString(),
                        createdAt: new Date().toISOString(),
                        isActive: true
                    };
                    announcements.push(newAnnouncement);
                    localStorage.setItem('announcements', JSON.stringify(announcements));
                    showNotification('Ank√ºndigung erstellt!', 'success');
                    loadAnnouncements();
                }
            } catch (error) {
                console.error('Failed to create announcement:', error);
                showNotification(`Fehler: ${error.message}`, 'danger');
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('M√∂chten Sie diese Ank√ºndigung wirklich l√∂schen?')) return;

            try {
                if (IS_PRODUCTION) {
                    const response = await fetch(`${API_BASE}/delete-announcement?id=${id}`, {
                        method: 'DELETE',
                        headers: { 'X-Admin-Auth': sessionStorage.getItem('adminAuth') }
                    });

                    if (response.ok) {
                        showNotification('Ank√ºndigung gel√∂scht!', 'success');
                        loadAnnouncements();
                    } else {
                        throw new Error('Failed to delete announcement');
                    }
                } else {
                    let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
                    announcements = announcements.filter(a => a.id !== id);
                    localStorage.setItem('announcements', JSON.stringify(announcements));
                    showNotification('Ank√ºndigung gel√∂scht!', 'success');
                    loadAnnouncements();
                }
            } catch (error) {
                console.error('Failed to delete announcement:', error);
                showNotification(`Fehler: ${error.message}`, 'danger');
            }
        }

        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcementsList');

            if (!announcements || announcements.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">Keine Ank√ºndigungen vorhanden.</p>';
                return;
            }

            const now = new Date();
            const sortedAnnouncements = announcements.sort((a, b) =>
                new Date(b.createdAt || b.created_at) - new Date(a.createdAt || a.created_at)
            );

            container.innerHTML = sortedAnnouncements.map(ann => {
                const startDate = new Date(ann.startDate || ann.start_date);
                const endDate = new Date(ann.endDate || ann.end_date);
                const isActive = now >= startDate && now <= endDate;
                const isScheduled = now < startDate;
                const isExpired = now > endDate;

                let statusBadge = '';
                if (isActive) statusBadge = '<span class="status-badge status-active">Aktiv</span>';
                else if (isScheduled) statusBadge = '<span class="status-badge status-scheduled">Geplant</span>';
                else if (isExpired) statusBadge = '<span class="status-badge status-expired">Abgelaufen</span>';

                const icons = {
                    'holiday': 'üññÔ∏è',
                    'emergency': 'üö®',
                    'news': 'üì∞',
                    'special': '‚≠ê',
                    'warning': '‚ö†Ô∏è'
                };

                return `
                    <div class="announcement-item">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5>${icons[ann.type] || 'üì¢'} ${ann.title}</h5>
                                <p class="mb-1">${ann.message}</p>
                                ${ann.substitute ? `<small class="text-muted">Vertretung: ${ann.substitute}</small><br>` : ''}
                                <small class="text-muted">
                                    ${startDate.toLocaleDateString('de-AT')} - ${endDate.toLocaleDateString('de-AT')}
                                </small>
                                <br>${statusBadge}
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="delete-btn" onclick="deleteAnnouncement('${ann.id}')" aria-label="Ank√ºndigung ${ann.title} l√∂schen">
                                    <i class="fas fa-trash"></i> L√∂schen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('announcementForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Speichert...';

            const announcement = {
                type: document.getElementById('announcementType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                title: document.getElementById('announcementTitle').value,
                message: document.getElementById('announcementMessage').value,
                substitute: document.getElementById('substituteInfo').value
            };

            await createAnnouncement(announcement);
            this.reset();

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Ank√ºndigung Speichern';
        });

        // ============================================
        // OPENING HOURS MANAGEMENT (FIXED VERSION)
        // ============================================

        // Load saved hours on page load
        function loadSavedHours() {
            const saved = localStorage.getItem('openingHours');
            if (!saved) return;

            try {
                const hours = JSON.parse(saved);

                if (hours.weekday) {
                    document.getElementById('weekday-open-1').value = hours.weekday.morning.open;
                    document.getElementById('weekday-close-1').value = hours.weekday.morning.close;
                    document.getElementById('weekday-open-2').value = hours.weekday.afternoon.open;
                    document.getElementById('weekday-close-2').value = hours.weekday.afternoon.close;
                }

                if (hours.saturday) {
                    document.getElementById('saturday-open').value = hours.saturday.open;
                    document.getElementById('saturday-close').value = hours.saturday.close;
                    document.getElementById('saturday-closed').checked = hours.saturday.closed;

                    if (hours.saturday.closed) {
                        document.getElementById('saturday-open').disabled = true;
                        document.getElementById('saturday-close').disabled = true;
                    }
                }

                if (hours.sunday) {
                    document.getElementById('sunday-closed').checked = hours.sunday.closed;

                    if (!hours.sunday.closed && hours.sunday.open && hours.sunday.close) {
                        document.getElementById('sunday-open').value = hours.sunday.open;
                        document.getElementById('sunday-close').value = hours.sunday.close;
                        document.getElementById('sunday-open').disabled = false;
                        document.getElementById('sunday-close').disabled = false;
                    }
                }

                updateHoursPreview();
                console.log('‚úÖ Loaded saved hours:', hours);
            } catch (error) {
                console.error('Error loading saved hours:', error);
            }
        }

        // Checkbox handlers
        document.getElementById('sunday-closed').addEventListener('change', function() {
            const open = document.getElementById('sunday-open');
            const close = document.getElementById('sunday-close');
            open.disabled = this.checked;
            close.disabled = this.checked;
            updateHoursPreview();
        });

        document.getElementById('saturday-closed').addEventListener('change', function() {
            const open = document.getElementById('saturday-open');
            const close = document.getElementById('saturday-close');
            open.disabled = this.checked;
            close.disabled = this.checked;
            updateHoursPreview();
        });

        // Update preview when inputs change
        ['weekday-open-1', 'weekday-close-1', 'weekday-open-2', 'weekday-close-2',
         'saturday-open', 'saturday-close', 'sunday-open', 'sunday-close'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', updateHoursPreview);
        });

        // Update preview display
        function updateHoursPreview() {
            const preview = document.getElementById('previewHoursList');
            if (!preview) return;

            const weekdayMorningOpen = document.getElementById('weekday-open-1').value;
            const weekdayMorningClose = document.getElementById('weekday-close-1').value;
            const weekdayAfternoonOpen = document.getElementById('weekday-open-2').value;
            const weekdayAfternoonClose = document.getElementById('weekday-close-2').value;

            const saturdayOpen = document.getElementById('saturday-open').value;
            const saturdayClose = document.getElementById('saturday-close').value;
            const saturdayClosed = document.getElementById('saturday-closed').checked;

            const sundayOpen = document.getElementById('sunday-open').value;
            const sundayClose = document.getElementById('sunday-close').value;
            const sundayClosed = document.getElementById('sunday-closed').checked;

            preview.innerHTML = `
                <li role="listitem">
                    <span class="day">Montag - Freitag</span>
                    <span class="time">${weekdayMorningOpen}-${weekdayMorningClose} & ${weekdayAfternoonOpen}-${weekdayAfternoonClose}</span>
                </li>
                <li role="listitem">
                    <span class="day">Samstag</span>
                    <span class="time" style="${saturdayClosed ? 'color: #ff4444; font-weight: 700;' : ''}">
                        ${saturdayClosed ? 'GESCHLOSSEN' : `${saturdayOpen} - ${saturdayClose}`}
                    </span>
                </li>
                <li role="listitem">
                    <span class="day">Sonntag</span>
                    <span class="time" style="${sundayClosed ? 'color: #ff4444; font-weight: 700;' : ''}">
                        ${sundayClosed ? 'GESCHLOSSEN' : `${sundayOpen} - ${sundayClose}`}
                    </span>
                </li>
            `;
        }

        // Save regular hours
        function saveRegularHours() {
            const hours = {
                weekday: {
                    morning: {
                        open: document.getElementById('weekday-open-1').value,
                        close: document.getElementById('weekday-close-1').value
                    },
                    afternoon: {
                        open: document.getElementById('weekday-open-2').value,
                        close: document.getElementById('weekday-close-2').value
                    }
                },
                saturday: {
                    open: document.getElementById('saturday-open').value,
                    close: document.getElementById('saturday-close').value,
                    closed: document.getElementById('saturday-closed').checked
                },
                sunday: {
                    open: document.getElementById('sunday-open').value,
                    close: document.getElementById('sunday-close').value,
                    closed: document.getElementById('sunday-closed').checked
                },
                lastUpdated: new Date().toISOString()
            };

            try {
                localStorage.setItem('openingHours', JSON.stringify(hours));
                console.log('‚úÖ Saved hours:', hours);
                showNotification('√ñffnungszeiten erfolgreich gespeichert! Die √Ñnderungen sind jetzt auf Ihrer Website sichtbar.', 'success');
                updateHoursPreview();
            } catch (error) {
                console.error('Error saving hours:', error);
                showNotification('Fehler beim Speichern der √ñffnungszeiten.', 'danger');
            }
        }

        // Reset to default hours
        function resetToDefaultHours() {
            if (!confirm('M√∂chten Sie die √ñffnungszeiten auf die Standardwerte zur√ºcksetzen?')) return;

            try {
                document.getElementById('weekday-open-1').value = DEFAULT_HOURS.weekday.morning.open;
                document.getElementById('weekday-close-1').value = DEFAULT_HOURS.weekday.morning.close;
                document.getElementById('weekday-open-2').value = DEFAULT_HOURS.weekday.afternoon.open;
                document.getElementById('weekday-close-2').value = DEFAULT_HOURS.weekday.afternoon.close;

                document.getElementById('saturday-open').value = DEFAULT_HOURS.saturday.open;
                document.getElementById('saturday-close').value = DEFAULT_HOURS.saturday.close;
                document.getElementById('saturday-closed').checked = DEFAULT_HOURS.saturday.closed;
                document.getElementById('saturday-open').disabled = false;
                document.getElementById('saturday-close').disabled = false;

                document.getElementById('sunday-closed').checked = DEFAULT_HOURS.sunday.closed;
                document.getElementById('sunday-open').disabled = true;
                document.getElementById('sunday-close').disabled = true;

                localStorage.removeItem('openingHours');

                updateHoursPreview();
                showNotification('√ñffnungszeiten wurden auf Standard zur√ºckgesetzt.', 'info');

                console.log('‚úÖ Reset to default hours');
            } catch (error) {
                console.error('Error resetting hours:', error);
                showNotification('Fehler beim Zur√ºcksetzen.', 'danger');
            }
        }

        // Preview on main site
        function previewHoursOnMainSite() {
            window.open('/', '_blank');
        }

        // ============================================
        // SEARCH MANAGEMENT (UNCHANGED)
        // ============================================

        function addPinnedResult() {
            const keyword = document.getElementById('pinnedKeyword').value;
            const url = document.getElementById('pinnedUrl').value;
            if (!keyword || !url) return;

            const pinned = JSON.parse(localStorage.getItem('pinnedResults') || '[]');
            pinned.push({ keyword, url, id: Date.now() });
            localStorage.setItem('pinnedResults', JSON.stringify(pinned));
            loadPinnedResults();

            document.getElementById('pinnedKeyword').value = '';
            document.getElementById('pinnedUrl').value = '';
            showNotification('Hinzugef√ºgt', 'success');
        }

        function loadPinnedResults() {
            const list = document.getElementById('pinnedList');
            if (!list) return;

            const pinned = JSON.parse(localStorage.getItem('pinnedResults') || '[]');
            list.innerHTML = pinned.map(item => `
                <div class="search-rule">
                    <div>
                        <span class="rule-type">PINNED</span>
                        <strong>${item.keyword}</strong> ‚Üí ${item.url}
                    </div>
                    <button class="delete-btn" onclick="removePinned(${item.id})" aria-label="Gepinntes Ergebnis f√ºr ${item.keyword} entfernen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function removePinned(id) {
            const pinned = JSON.parse(localStorage.getItem('pinnedResults') || '[]');
            localStorage.setItem('pinnedResults', JSON.stringify(pinned.filter(item => item.id !== id)));
            loadPinnedResults();
        }

        function addExcludedTerm() {
            const term = document.getElementById('excludedTerm').value;
            if (!term) return;

            const excluded = JSON.parse(localStorage.getItem('excludedTerms') || '[]');
            excluded.push({ term, id: Date.now() });
            localStorage.setItem('excludedTerms', JSON.stringify(excluded));
            loadExcludedTerms();

            document.getElementById('excludedTerm').value = '';
            showNotification('Begriff ausgeschlossen', 'success');
        }

        function loadExcludedTerms() {
            const list = document.getElementById('excludedList');
            if (!list) return;

            const excluded = JSON.parse(localStorage.getItem('excludedTerms') || '[]');
            list.innerHTML = excluded.map(item => `
                <div class="search-rule">
                    <div>
                        <span class="rule-type" style="background: #dc3545;">EXCLUDED</span>
                        ${item.term}
                    </div>
                    <button class="delete-btn" onclick="removeExcluded(${item.id})" aria-label="Ausschluss f√ºr ${item.term} entfernen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeExcluded(id) {
            const excluded = JSON.parse(localStorage.getItem('excludedTerms') || '[]');
            localStorage.setItem('excludedTerms', JSON.stringify(excluded.filter(item => item.id !== id)));
            loadExcludedTerms();
        }

        function addSynonym() {
            const term = document.getElementById('synonymTerm').value;
            const aliases = document.getElementById('synonymAlias').value;
            if (!term || !aliases) return;

            const synonyms = JSON.parse(localStorage.getItem('synonyms') || '[]');
            synonyms.push({ term, aliases: aliases.split(',').map(a => a.trim()), id: Date.now() });
            localStorage.setItem('synonyms', JSON.stringify(synonyms));
            loadSynonyms();

            document.getElementById('synonymTerm').value = '';
            document.getElementById('synonymAlias').value = '';
            showNotification('Synonym hinzugef√ºgt', 'success');
        }

        function loadSynonyms() {
            const list = document.getElementById('synonymsList');
            if (!list) return;

            const synonyms = JSON.parse(localStorage.getItem('synonyms') || '[]');
            list.innerHTML = synonyms.map(item => `
                <div class="search-rule">
                    <div>
                        <span class="rule-type" style="background: #28a745;">SYNONYM</span>
                        <strong>${item.term}</strong> = ${item.aliases.join(', ')}
                    </div>
                    <button class="delete-btn" onclick="removeSynonym(${item.id})" aria-label="Synonym f√ºr ${item.term} entfernen">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeSynonym(id) {
            const synonyms = JSON.parse(localStorage.getItem('synonyms') || '[]');
            localStorage.setItem('synonyms', JSON.stringify(synonyms.filter(item => item.id !== id)));
            loadSynonyms();
        }

        function saveMetadata() {
            const metadata = {
                title: document.getElementById('metaTitle').value,
                description: document.getElementById('metaDescription').value,
                keywords: document.getElementById('metaKeywords').value
            };
            localStorage.setItem('siteMetadata', JSON.stringify(metadata));
            showNotification('Metadaten gespeichert', 'success');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
            notification.style.zIndex = '9999';
            notification.setAttribute('role', 'alert');
            notification.innerHTML = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        function viewWebsite() {
            window.open('/', '_blank');
        }

        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                sessionStorage.clear();
                window.location.href = '/admin/';
            }
        }

        function loadAllStoredData() {
            loadSavedHours();
            loadPinnedResults();
            loadExcludedTerms();
            loadSynonyms();

            const metadata = JSON.parse(localStorage.getItem('siteMetadata') || '{}');
            if (metadata.title) document.getElementById('metaTitle').value = metadata.title;
            if (metadata.description) document.getElementById('metaDescription').value = metadata.description;
            if (metadata.keywords) document.getElementById('metaKeywords').value = metadata.keywords;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            loadAnnouncements();
            loadAllStoredData();
        });

        // Initialize when opening hours tab becomes active
        document.querySelector('a[href="#opening-hours"]').addEventListener('click', function() {
            setTimeout(() => {
                loadSavedHours();
                updateHoursPreview();
            }, 100);
        });
    </script>
</body>
</html>
